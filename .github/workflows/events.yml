name: KIND K8s AI Analysis (CI-friendly)

on:
  push:
  workflow_dispatch:
  schedule:
    - cron: '0 18 * * *'  # daily at 18:00 UTC (~11:30 PM IST)

jobs:
  kind-analysis:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install prerequisites
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends curl jq conntrack ca-certificates

      - name: Ensure Docker is running
        run: |
          sudo systemctl enable docker || true
          sudo systemctl start docker || true
          docker --version

      - name: Install kubectl
        run: |
          KUBECTL_VERSION=$(curl -s https://storage.googleapis.com/kubernetes-release/release/stable.txt)
          curl -LO "https://storage.googleapis.com/kubernetes-release/release/${KUBECTL_VERSION}/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/

      - name: Install kind
        run: |
          KIND_VERSION="v0.20.0"
          curl -Lo ./kind "https://kind.sigs.k8s.io/dl/${KIND_VERSION}/kind-linux-amd64"
          chmod +x ./kind
          sudo mv ./kind /usr/local/bin/kind
          kind --version

      - name: Create kind cluster
        run: |
          # create a cluster and wait for control plane to be ready
          kind create cluster --name ci-kind --wait 120s
          kubectl cluster-info
          kubectl get nodes -o wide

      - name: Apply broken deployment (no validation)
        run: |
          kubectl apply -f kubernetes/bad-deployment.yaml --validate=false

      - name: Wait for resources and show pods
        run: |
          # wait up to 60s for pods to appear
          for i in {1..12}; do
            kubectl get pods -A && break || true
            echo "waiting for pods... ($i/12)"
            sleep 5
          done
          kubectl get pods -A -o wide

      - name: Run collection script
        run: |
          chmod +x scripts/collect.sh
          bash scripts/collect.sh
          echo "Collected output:"
          sed -n '1,200p' scripts/output.txt || true

      - name: Try AI analysis (only if Ollama present)
        run: |
          chmod +x scripts/analyze.sh || true
          if command -v ollama >/dev/null 2>&1; then
            echo "ollama found — running analyze.sh"
            bash scripts/analyze.sh
          else
            echo "ollama not found — skipping analyze.sh (inspect artifact)"
          fi

      - name: Upload logs artifact
        uses: actions/upload-artifact@v4
        with:
          name: k8s-output
          path: scripts/output.txt

      - name: Tear down kind cluster
        if: always()
        run: |
          kind delete cluster --name ci-kind || true

